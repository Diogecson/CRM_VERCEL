
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <title>Dashboard Interativo Completo</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #0d0d1a;
      color: #ffffff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    select, input[type="text"], input[type="date"] {
      padding: 8px;
      border-radius: 5px;
      background-color: #1a1a2e;
      color: #fff;
      border: none;
      margin-right: 10px;
    }
    .container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-gap: 20px;
    }
    .card {
      background-color: #1a1a2e;
      padding: 15px;
      border-radius: 10px;
    }
    .card h3 {
      margin-bottom: 10px;
      color: #00e0ff;
    }
    canvas {
      background-color: #12122b;
      border-radius: 10px;
      padding: 10px;
    }
    .indicadores {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 30px;
    }
    .card-indicador {
      background-color: #1a1a2e;
      padding: 15px 25px;
      border-radius: 10px;
      min-width: 150px;
      flex: 1;
    }
    .card-indicador h4 {
      margin: 0 0 10px;
      color: #00e0ff;
      font-size: 16px;
    }
    .card-indicador p {
      font-size: 20px;
      font-weight: bold;
    }
    .btn {
      text-decoration: none;
      background-color: #00bfa6;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #1a1a2e;
      margin-top: 20px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #333;
      text-align: left;
    }
    th {
      background-color: #12122b;
      color: #00e0ff;
    }
    tr:hover {
      background-color: #292947;
    }
  </style>
  </head>
<body>

<h2>Dashboard com GrÃ¡ficos + Tabela Detalhadas</h2>
</a>
<h2></h2>
<div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
  <div>
    <div style="margin-bottom: 20px; display: flex; gap: 10px;">
      <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
        <div style="margin-bottom: 20px; display: flex; gap: 10px; justify-content: flex-end; align-items: center;">

          <!-- BotÃ£o Atualizar -->
          <a href="/dashboard-completo" style="
            font-size: 14px;
            color: #00e0ff;
            background-color: transparent;
            border: 1px solid #00e0ff;
            padding: 6px 12px;
            border-radius: 5px;
            text-decoration: none;
            transition: 0.3s;
          ">ðŸ”„ Atualizar</a>
        
          <!-- BotÃ£o Ir para Dashboard -->
          <a href="/dashboard" style="
            font-size: 14px;
            color: #00e0ff;
            background-color: transparent;
            border: 1px solid #00e0ff;
            padding: 6px 12px;
            border-radius: 5px;
            text-decoration: none;
            transition: 0.3s;
          ">ðŸ“Š Ver Resumo</a>
        
          <!-- BotÃ£o Sair -->
          <a href="/logout" style="
            font-size: 14px;
            color: #ff4d4d;
            background-color: transparent;
            border: 1px solid #ff4d4d;
            padding: 6px 12px;
            border-radius: 5px;
            text-decoration: none;
            transition: 0.3s;
          ">ðŸšª Sair</a>

                 
        </div>
        
        
  </div>
</div>
<h2></h2>
<!-- Indicadores -->
<div class="indicadores">
  <div class="card-indicador"><h4>Total Telefones</h4><p id="ind-total-telefones"></p></div>
  <div class="card-indicador"><h4>Total Contatados</h4><p id="ind-total-contatados"></p></div>
  <div class="card-indicador"><h4>Total NÃ£o Contatados</h4><p id="ind-nao-contatados"></p></div>
  <div class="card-indicador"><h4>Finalizados</h4><p id="ind-finalizados"></p></div>
  <div class="card-indicador"><h4>Em NegociaÃ§Ã£o</h4><p id="ind-negociacao"></p></div>
  <div class="card-indicador"><h4>Matriculados</h4><p id="ind-matriculados"></p></div>
  <div class="card-indicador"><h4>Contatados Hoje</h4><p id="ind-hoje"></p></div>
  <div class="card-indicador"><h4>JÃ¡ Ã© Aluno</h4><p id="ind-ja-aluno"></p></div>
</div>

<!-- Filtros Globais -->
<div style="margin-bottom: 20px;">
  <label>Consultor:</label>
  <select id="filtroConsultor"><option value="">Todos</option></select>

  <label>Status:</label>
  <select id="filtroStatus">
    <option value="">Todos</option>
    <option value="Finalizado">Finalizado</option>
    <option value="Em NegociaÃ§Ã£o">Em NegociaÃ§Ã£o</option>
    <option value="Matriculado">Matriculado</option>
    <option value="JÃ¡ Ã© Aluno">JÃ¡ Ã© Aluno</option>
  </select>

  <label>MÃªs:</label>
  <select id="filtroMes">
    <option value="">Todos</option>
    <script>
      for (let i = 1; i <= 12; i++) {
        const val = i.toString().padStart(2, '0');
        document.write(`<option value="${val}">${val}</option>`);
      }
    </script>
  </select>

  

  <label for="filtroDiaSemana">Dia da Semana:</label>
  <select id="filtroDiaSemana">
    <option value="">Todos</option>
    <option value="domingo">Domingo</option>
    <option value="segunda-feira">Segunda-feira</option>
    <option value="terÃ§a-feira">TerÃ§a-feira</option>
    <option value="quarta-feira">Quarta-feira</option>
    <option value="quinta-feira">Quinta-feira</option>
    <option value="sexta-feira">Sexta-feira</option>
    <option value="sÃ¡bado">SÃ¡bado</option>
  </select>
  
  <label for="filtroDiaNumero">Dia:</label>
  <input type="number" min="1" max="31" id="filtroDiaNumero" placeholder="Ex: 10" style="width: 80px;">

</div>

<!-- GrÃ¡ficos -->
<div class="container">
  <div class="card">
    <h3>NegociaÃ§Ãµes por MÃªs</h3>
    <canvas id="graficoNegociacoesMes"></canvas>
  </div>
  <div class="card">
    <h3>Matriculados por Dia da Semana</h3>
    <canvas id="graficoMatriculadosMes"></canvas>
  </div>
  <div class="card" style="grid-column: span 2;">
    <h3>Status dos Alunos</h3>
    <canvas id="graficoStatusAluno"></canvas>
  </div>
</div>

<!-- Filtros da tabela -->
<div class="filtro">
  <input type="text" id="filtroNome" placeholder="Filtrar por Nome">
  <input type="text" id="filtroTelefone" placeholder="Filtrar por Telefone">
  <input type="text" id="filtroEmail" placeholder="Filtrar por Email">
  <input type="text" id="filtroBase" placeholder="Filtrar por Base">
  <input type="text" id="filtroBaseDisp" placeholder="Filtrar por Base Disponibilizada">
</div>

<table id="tabelaContatos">
  <thead>
    <tr>
      <th>Nome</th>
      <th>Telefone</th>
      <th>Email</th>
      <th>Base</th>
      <th>Base Disponibilizada</th>
      <th>Consultor</th>
      <th>Status</th>
      <th>Primeiro Contato</th>
      <th>Segundo Contato</th>
      <th>Finalizado</th>
      <th>Data</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div style="margin-top: 20px; display: flex; gap: 10px; align-items: center;">
  <button onclick="paginaAnterior()" class="btn">â—€ Anterior</button>
  <span id="paginacaoInfo">PÃ¡gina 1</span>
  <button onclick="proximaPagina()" class="btn">PrÃ³xima â–¶</button>
</div>

<script>
  const todosDados = {{ todosDados|tojson }};
  const todosDadosTabela = todosDados.totais?.contatos || [];
  
  // Popular filtro de consultores
  const filtroConsultor = document.getElementById('filtroConsultor');
  if (filtroConsultor && todosDadosTabela.length > 0) {
    const consultoresUnicos = [...new Set(todosDadosTabela.map(c => c.Consultor).filter(Boolean))].sort();
    consultoresUnicos.forEach(nome => {
      const option = document.createElement('option');
      option.value = nome;
      option.textContent = nome;
      filtroConsultor.appendChild(option);
    });
  }
  
  let paginaAtual = 1;
  const porPagina = 50;
  let dadosFiltrados = [];
  
  const chartNegociacoes = new Chart(document.getElementById('graficoNegociacoesMes'), {
    type: 'bar',
    data: { labels: [], datasets: [{ label: 'NegociaÃ§Ãµes', data: [], backgroundColor: '#00e0ff' }] }
  });
  const chartStatusAluno = new Chart(document.getElementById('graficoStatusAluno'), {
    type: 'bar',
    data: { labels: [], datasets: [{ label: 'Status', data: [], backgroundColor: '#ff6384' }] }
  });
  const chartMatriculados = new Chart(document.getElementById('graficoMatriculadosMes'), {
    type: 'bar',
    data: { labels: [], datasets: [{ label: 'Matriculados por Dia', data: [], backgroundColor: '#00bfa6' }] }
  });
  
  function atualizarIndicadores(ind) {
    document.getElementById("ind-total-telefones").innerText = ind["Total Telefones"] || 0;
    document.getElementById("ind-total-contatados").innerText = ind["Total Contatados"] || 0;
    document.getElementById("ind-nao-contatados").innerText = ind["Total NÃ£o Contatados"] || 0;
    document.getElementById("ind-finalizados").innerText = ind["Finalizados"] || 0;
    document.getElementById("ind-negociacao").innerText = ind["Em NegociaÃ§Ã£o"] || 0;
    document.getElementById("ind-matriculados").innerText = ind["Matriculados"] || 0;
    document.getElementById("ind-ja-aluno").innerText = ind["JÃ¡ Ã© Aluno"] || 0;
    document.getElementById("ind-hoje").innerText = ind["Contatados Hoje"] || 0;
  }
  
  function atualizarGraficosComTabela() {
    const indicadores = {
      "Total Telefones": dadosFiltrados.length,
      "Total Contatados": dadosFiltrados.filter(c => c.Primeiro_contato).length,
      "Total NÃ£o Contatados": dadosFiltrados.filter(c => !c.Primeiro_contato).length,
      "Finalizados": dadosFiltrados.filter(c => c.Status_aluno === "Finalizado").length,
      "Em NegociaÃ§Ã£o": dadosFiltrados.filter(c => c.Status_aluno === "Em NegociaÃ§Ã£o").length,
      "Matriculados": dadosFiltrados.filter(c => c.Status_aluno === "Matriculado").length,
      "JÃ¡ Ã© Aluno": dadosFiltrados.filter(c => c.Status_aluno === "JÃ¡ Ã© Aluno").length,
      "Contatados Hoje": dadosFiltrados.filter(c => {
        if (!c.Primeiro_contato) return false;
        const dataContato = new Date(c.Primeiro_contato);
        const hoje = new Date();
        return dataContato.toDateString() === hoje.toDateString();
      }).length

          };
  
    const negociacoes = {}, matriculadosMes = {}, status_aluno = {}, matriculadosSemana = {};
  
    dadosFiltrados.forEach(c => {
      // Por mÃªs
      const mes = c.Primeiro_contato?.split("/").slice(1).reverse().join("/") || "Sem Data";
      if (c.Status_aluno === "Em NegociaÃ§Ã£o") negociacoes[mes] = (negociacoes[mes] || 0) + 1;
      if (c.Status_aluno === "Matriculado") matriculadosMes[mes] = (matriculadosMes[mes] || 0) + 1;
      if (c.Status_aluno) status_aluno[c.Status_aluno] = (status_aluno[c.Status_aluno] || 0) + 1;
  
      // Por dia da semana (usando Primeiro_contato)
      if (c.Status_aluno === "Matriculado" && c.Primeiro_contato) {
        const partes = c.Primeiro_contato.split("/");
        if (partes.length === 3) {
          const dataJS = new Date(`${partes[2]}-${partes[1]}-${partes[0]}`);
          if (!isNaN(dataJS)) {
            const dia = dataJS.toLocaleDateString("pt-BR", { weekday: 'long' });
            matriculadosSemana[dia] = (matriculadosSemana[dia] || 0) + 1;
          }
        }
      }

    });
    
    atualizarIndicadores(indicadores);
  
    chartNegociacoes.data.labels = Object.keys(negociacoes);
    chartNegociacoes.data.datasets[0].data = Object.values(negociacoes);
    chartNegociacoes.update();
  
    chartStatusAluno.data.labels = Object.keys(status_aluno);
    chartStatusAluno.data.datasets[0].data = Object.values(status_aluno);
    chartStatusAluno.update();
  
    // Ordenar dias da semana corretamente
    const ordemDias = ["segunda-feira", "terÃ§a-feira", "quarta-feira", "quinta-feira", "sexta-feira", "sÃ¡bado", "domingo"];
    const labelsOrdenados = ordemDias.filter(d => d in matriculadosSemana);
    const dadosOrdenados = labelsOrdenados.map(d => matriculadosSemana[d]);
  
    chartMatriculados.data.labels = labelsOrdenados;
    chartMatriculados.data.datasets[0].data = dadosOrdenados;
    chartMatriculados.update();
  }
  
  function aplicarFiltrosTabela() {
    const nome = document.getElementById('filtroNome').value.toLowerCase();
    const telefone = document.getElementById('filtroTelefone').value.toLowerCase();
    const email = document.getElementById('filtroEmail').value.toLowerCase();
    const base = document.getElementById('filtroBase').value.toLowerCase();
    const baseDisp = document.getElementById('filtroBaseDisp').value.toLowerCase();
    const consultor = document.getElementById('filtroConsultor')?.value;
    const status = document.getElementById('filtroStatus')?.value.toLowerCase();
    const mes = document.getElementById('filtroMes')?.value;
    const diaNumero = document.getElementById('filtroDiaNumero')?.value;
    const diaSemanaFiltro = document.getElementById('filtroDiaSemana')?.value.toLowerCase();
  
    dadosFiltrados = todosDadosTabela.filter(dado => {
      const condTexto =
        dado.Nome.toLowerCase().includes(nome) &&
        dado.Telefone.toLowerCase().includes(telefone) &&
        dado.Email.toLowerCase().includes(email) &&
        dado.Base.toLowerCase().includes(base) &&
        dado.Base_disponibilizada.toLowerCase().includes(baseDisp);
  
      const condConsultor = !consultor || dado.Consultor === consultor;
  
      const condStatus = !status || (
        dado.Status_aluno && 
        dado.Status_aluno.toLowerCase().includes(status)
      );
  
      const condMes = !mes || (() => {
        const dataStr = dado.Primeiro_contato;
        if (!dataStr) return false;
        const dataJS = new Date(dataStr);
        if (isNaN(dataJS)) return false;
        const mesRegistro = (dataJS.getMonth() + 1).toString().padStart(2, '0');
        return mesRegistro === mes;
      })();
  
      const condDiaNumero = !diaNumero || (() => {
        const dataStr = dado.Primeiro_contato;
        if (!dataStr) return false;
        const dataJS = new Date(dataStr);
        if (isNaN(dataJS)) return false;
        const diaRegistro = dataJS.getDate().toString().padStart(2, '0');
        return diaRegistro === diaNumero.padStart(2, '0');
      })();
  
      const condDiaSemana = !diaSemanaFiltro || (() => {
        if (!dado.Data) return false;
        const dataJS = new Date(dado.Data);
        if (isNaN(dataJS)) return false;
        const diaSem = dataJS.toLocaleDateString("pt-BR", { weekday: 'long' }).toLowerCase();
        return diaSem === diaSemanaFiltro;
      })();
  
      return condTexto && condConsultor && condStatus && condMes && condDiaNumero && condDiaSemana;
    });
  
    paginaAtual = 1;
    renderizarTabela();
  }
  
  

  
  function renderizarTabela() {
    const corpoTabela = document.querySelector('#tabelaContatos tbody');
    corpoTabela.innerHTML = '';
  
    const inicio = (paginaAtual - 1) * porPagina;
    const fim = inicio + porPagina;
    const paginaDados = dadosFiltrados.slice(inicio, fim);
  
    paginaDados.forEach(dado => {
      const linha = `
        <tr>
          <td>${dado.Nome}</td>
          <td>${dado.Telefone}</td>
          <td>${dado.Email}</td>
          <td>${dado.Base}</td>
          <td>${dado.Base_disponibilizada}</td>
          <td>${dado.Consultor}</td>
          <td>${dado.Status_aluno}</td>
          <td>${dado.Primeiro_contato}</td>
          <td>${dado.Segundo_contato}</td>
          <td>${dado.Finalizado}</td>
          <td>${dado.Data || ""}</td>
        </tr>`;
      corpoTabela.insertAdjacentHTML('beforeend', linha);
    });
  
    document.getElementById('paginacaoInfo').innerText =
      `PÃ¡gina ${paginaAtual} de ${Math.ceil(dadosFiltrados.length / porPagina)}`;
  
    console.log("Dados filtrados:", dadosFiltrados.filter(c => c.Status_aluno === "Matriculado"));
  
    atualizarGraficosComTabela();
    const matriculadosSemana = {};

dadosFiltrados.forEach(c => {
  if (c.Status_aluno?.toLowerCase() === "matriculado" && c.Data) {
    const dataJS = new Date(c.Data); // jÃ¡ estÃ¡ no formato YYYY-MM-DD
    if (!isNaN(dataJS)) {
      const dia = dataJS.toLocaleDateString("pt-BR", { weekday: 'long' });
      matriculadosSemana[dia] = (matriculadosSemana[dia] || 0) + 1;
    }
    }
  });

    chartMatriculados.data.labels = Object.keys(matriculadosSemana);
    chartMatriculados.data.datasets[0].data = Object.values(matriculadosSemana);
    chartMatriculados.update();

  }
  
  function proximaPagina() {
    if (paginaAtual * porPagina < dadosFiltrados.length) {
      paginaAtual++;
      renderizarTabela();
    }
  }
  
  function paginaAnterior() {
    if (paginaAtual > 1) {
      paginaAtual--;
      renderizarTabela();
    }
  }
  
  document.querySelectorAll('input, select').forEach(el => {
    el.addEventListener('input', aplicarFiltrosTabela);
    el.addEventListener('change', aplicarFiltrosTabela);
  });
  
  dadosFiltrados = todosDadosTabela;
  renderizarTabela();
  </script>
  

</body>
</html>
